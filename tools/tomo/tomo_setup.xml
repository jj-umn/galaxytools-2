<tool id="tomo_setup" name="Tomo Setup" version="0.2.0" python_template_version="3.9">
    <description>Preprocess tomography images</description>
    <macros>
        <import>tomo_macros.xml</import>
    </macros>
    <expand macro="requirements" />
    <command detect_errors="exit_code">
        <![CDATA[
            mkdir setup_pngs;
            #if str( $input.type_selector ) == "collection"
                cp '$inputfiles' inputfiles.txt &&
            #end if
            $__tool_directory__/tomo_setup.py
            #if str( $input.type_selector ) == "collection"
                -i inputfiles.txt
                -t 'collection'
            #else:
                -i #for $s in $input.tomo_sets# '${s.inputs}' #end for#
                -t #for $s in $input.tomo_sets# '${s.set_type.type_selector}' #end for#
            #end if
            -c '$config'
            --theta_range '$thetas.theta_start $thetas.theta_end $thetas.num_thetas'
            --output_data 'output_data.npz'
            --output_config 'output_config.yaml'
            -l '$log'
            #for $s in $input.tomo_sets# ${s.offset} ${s.num} #end for
        ]]>
    </command>
    <configfiles>
         <configfile name="inputfiles"><![CDATA[#slurp
#if str( $input.type_selector ) == "collection"
#for $s in $input.tomo_sets
#for $input in $s.inputs
#echo str($input) + '\t' + $input.element_identifier #
#end for
#end for
#end if
]]></configfile>
    </configfiles>
    <inputs>
        <expand macro="common_inputs"/>
        <section name="thetas" title="Tomography angles">
            <param name="theta_start" type="float" min="0.0" max="360.0" value="0.0" label="Lower bound"/>
            <param name="theta_end" type="float" min="0.0" max="360.0" value="0.0" label="Upper bound"/>
            <param name="num_thetas" type="integer" min="1" value="1" label="Number of angles"/>
        </section>

        <conditional name="input">
            <param name="type_selector" type="select" label="Choose the dataset format">
                <option value="collection">datasets as collections</option>
                <option value="file">datasets as files</option>
            </param>
            <when value="collection">
                <repeat name='tomo_sets' title="Tomography image collections">
                    <param name="inputs" type="data_collection" label="Image file collection"/>
                    <param name="offset" type="integer" min="0" value="0" label="Image index offset"/>
                    <param name="num" type="integer" min="1" value="1" label="Number of images"/>
                </repeat>
            </when>
            <when value="file">
                <repeat name='tomo_sets' title="Tomography image datasets">
                    <conditional name="set_type">
                        <param name="type_selector" type="select" label="Choose the dataset type">
                            <option value="tdf">dark field</option>
                            <option value="tbf">bright field</option>
                            <option value="data">tomography field</option>
                        </param>
                    </conditional>
                    <param name="inputs" type="data" format='h5' optional='false' label="Image file"/>
                    <param name="offset" type="integer" min="0" value="0" label="Image index offset"/>
                    <param name="num" type="integer" min="1" value="1" label="Number of images"/>
                </repeat>
            </when>
        </conditional>
    </inputs>
    <outputs>
        <expand macro="common_outputs"/>
        <when input="input.type_selector" value="collection">
            <data name="inputfiles" format="txt" label="Input files" from_work_dir="inputfiles.txt" hidden="true"/>
        </when>
        <collection name="setup_pngs" type="list" label="Tomo setup images">
            <discover_datasets pattern="__name_and_ext__" directory="setup_pngs"/>
        </collection>
        <data name="output_config" format="yaml" label="Output config setup" from_work_dir="output_config.yaml"/>
        <data name="output_data" format="npz" label="Preprocessed tomography data" from_work_dir="output_data.npz"/>
    </outputs>
    <help><![CDATA[
        Preprocess tomography images.
    ]]></help>
    <expand macro="citations"/>
</tool>
