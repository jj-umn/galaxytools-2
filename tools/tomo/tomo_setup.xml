<tool id="tomo_setup" name="Tomo Setup" version="0.2.1" python_template_version="3.9">
    <description>Preprocess tomography images</description>
    <macros>
        <import>tomo_macros.xml</import>
    </macros>
    <expand macro="requirements" />
    <command detect_errors="exit_code">
        <![CDATA[
            mkdir setup_pngs;
            #if str( $input.type_selector ) == "collection"
                cp '$inputfiles' inputfiles.txt &&
            #end if
            $__tool_directory__/tomo_setup.py
            #if str( $input.type_selector ) == "collection"
                -i 'inputfiles.txt'
                -t 'collection'
            #else:
                -i #for $s in $input.tomo_sets# '${s.inputs}' #end for#
                -t #for $s in $input.tomo_sets# '${s.set_type.set_selector}' #end for#
            #end if
            -c '$config'
            --theta_range '$thetas.theta_start $thetas.theta_end $thetas.num_thetas'
            --output_data 'output_data.npz'
            --output_config 'output_config.yaml'
            -l '$log'

        ]]>
    </command>
    <!--
    #for $s in $input.tomo_sets# ${s.offset} ${s.num} ${s.ref_height} #end for
    -->
    <configfiles>
         <configfile name="inputfiles">
             <![CDATA[#slurp
                #if str( $input.type_selector ) == "collection"
                    #for $s in $input.tomo_sets
                        #for $input in $s.inputs
                            #echo str($input) + '\t' + $input.element_identifier #
                        #end for
                    #end for
                #end if
            ]]>
        </configfile>
    </configfiles>
    <inputs>
        <conditional name="config_type">
            <param name="config_selector" type="select" label="Read config from file or enter manually">
                <option value="config_file" selected="true">Read config from file</option>
                <option value="config_manual">Manually enter config parameters</option>
            </param>
            <when value="config_file">
                <expand macro="common_inputs"/>
                <param name="num_stack" type="select" label="number of stacks">
                    <options>
                        <filter type="data_meta" ref="config" key="num_stack"/>
                    </options>
                </param>
                <section name="thetas" title="Tomography angles">
                    <param name="theta_start" type="select" label="Lower theta range value (from config)">
                        <options>
                            <filter type="data_meta" ref="config" key="theta_start"/>
                        </options>
                    </param>
                    <param name="theta_end" type="select" label="Upper theta range value (from config)">
                        <options>
                            <filter type="data_meta" ref="config" key="theta_end"/>
                        </options>
                    </param>
                    <param name="num_thetas" type="integer" min="1" value="1" optional="false" label="Number of angles"/>
                </section>
                <conditional name="input">
                    <param name="type_selector" type="select" label="Choose the dataset format">
                        <option value="collections">datasets as collections</option>
                        <option value="files">datasets as files</option>
                    </param>
                    <when value="collections">
                        <repeat name='tomo_sets' title="Tomography image collections">
                            <param name="inputs" type="data_collection" label="Image file collection"/>
                            <param name="offset" type="integer" min="0" value="0" label="Image index offset"/>
                            <!--
                            <param name="ref_height" type="select" label="Reference height (from config)">
                                <options>
                                    <filter type="data_meta" ref="config" key="ref_height"/>
                                </options>
                            </param>
                            -->
                        </repeat>
                    </when>
                    <when value="files">
                        <repeat name='tomo_sets' title="Tomography image datasets">
                            <param name="inputs" type="data" format='h5' optional='false' label="Image file"/>
                            <conditional name="set_type">
                                <param name="set_selector" type="select" label="Choose the dataset type">
                                    <option value="tdf">dark field</option>
                                    <option value="tbf">bright field</option>
                                    <option value="data">tomography field</option>
                                </param>
                                <when value="tdf">
                                    <param name="offset" type="integer" min="0" value="0" label="Image index offset"/>
                                    <param name="num" type="integer" min="1" value="1" label="Number of images"/>
                                </when>
                                <when value="tbf">
                                    <param name="offset" type="integer" min="0" value="0" label="Image index offset"/>
                                    <param name="num" type="integer" min="1" value="1" label="Number of images"/>
                                </when>
                                <when value="data">
                                    <param name="offset" type="integer" min="0" value="0" label="Image index offset"/>
                                    <!--
                                    <param name="ref_height" type="select" label="Reference height (from config)">
                                        <options>
                                            <filter type="data_meta" ref="config" key="ref_height"/>
                                        </options>
                                    </param>
                                    -->
                                </when>
                            </conditional>
                        </repeat>
                    </when>
                </conditional>
            </when>
            <when value="config_manual">
                <param name="num_stack" type="integer" min="1" value="1" label="Number of stacks"/>
                <section name="thetas" title="Tomography angles">
                    <param name="theta_start" type="float" min="0.0" max="360.0" value="0.0" label="Lower bound"/>
                    <param name="theta_end" type="float" min="0.0" max="360.0" value="0.0" label="Upper bound"/>
                    <param name="num_thetas" type="integer" min="1" value="1" label="Number of angles"/>
                </section>
                <conditional name="input">
                    <param name="type_selector" type="select" label="Choose the dataset format">
                        <option value="collections">datasets as collections</option>
                        <option value="files">datasets as files</option>
                    </param>
                    <when value="collections">
                        <repeat name='tomo_sets' title="Tomography image collections">
                            <param name="inputs" type="data_collection" label="Image file collection"/>
                            <param name="offset" type="integer" min="0" value="0" label="Image index offset"/>
                            <param name="ref_height" type="float" value="0.0" label="Reference height"/>
                        </repeat>
                    </when>
                    <when value="files">
                        <repeat name='tomo_sets' title="Tomography image datasets">
                            <param name="inputs" type="data" format='h5' optional='false' label="Image file"/>
                            <conditional name="set_type">
                                <param name="set_selector" type="select" label="Choose the dataset type">
                                    <option value="tdf">dark field</option>
                                    <option value="tbf">bright field</option>
                                    <option value="data">tomography field</option>
                                </param>
                                <when value="tdf">
                                    <param name="offset" type="integer" min="0" value="0" label="Image index offset"/>
                                    <param name="num" type="integer" min="1" value="1" label="Number of images"/>
                                </when>
                                <when value="tbf">
                                    <param name="offset" type="integer" min="0" value="0" label="Image index offset"/>
                                    <param name="num" type="integer" min="1" value="1" label="Number of images"/>
                                </when>
                                <when value="data">
                                    <param name="offset" type="integer" min="0" value="0" label="Image index offset"/>
                                    <param name="ref_height" type="float" value="0.0" label="Reference height"/>
                                </when>
                            </conditional>
                        </repeat>
                    </when>
                </conditional>
            </when>
        </conditional>
    </inputs>
    <outputs>
        <expand macro="common_outputs"/>
        <data name="inputfiles" format="txt" label="Input files" from_work_dir="inputfiles.txt" hidden="true">
            <filter>input['type_selector'] == 'collections'</filter>
        </data>
        <collection name="setup_pngs" type="list" label="Tomo setup images">
            <discover_datasets pattern="__name_and_ext__" directory="setup_pngs"/>
        </collection>
        <data name="output_config" format="yaml" label="Output config setup" from_work_dir="output_config.yaml"/>
        <data name="output_data" format="npz" label="Preprocessed tomography data" from_work_dir="output_data.npz"/>
    </outputs>
    <help>
        <![CDATA[
            Preprocess tomography images.
        ]]>
    </help>
    <expand macro="citations"/>
</tool>
